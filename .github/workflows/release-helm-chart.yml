name: Release Helm Chart

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags (e.g., v1.0.0)
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Chart version (e.g., 0.1.0)'
        required: true
        type: string

env:
  CHART_NAME: netmaker-k8s-ops
  HELM_CHART_DIR: deploy/netmaker-k8s-ops

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Install AWS CLI
        run: |
          if ! command -v aws &> /dev/null; then
            echo "Installing AWS CLI..."
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip -q awscliv2.zip
            sudo ./aws/install
          else
            echo "AWS CLI already installed, updating..."
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip -q awscliv2.zip
            sudo ./aws/install --update
          fi
          aws --version

      - name: Configure AWS CLI for DigitalOcean Spaces
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.DO_SPACES_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.DO_SPACES_SECRET }}
          AWS_DEFAULT_REGION: ${{ secrets.DO_SPACES_REGION }}
          SPACES_BUCKET: ${{ secrets.DO_SPACES_BUCKET }}
          SPACES_ENDPOINT: ${{ secrets.DO_SPACES_ENDPOINT }}
        run: |
          echo "AWS CLI configured for DigitalOcean Spaces"

      - name: Determine chart version
        id: chart_version
        run: |
          if [ "${{ github.event_name }}" == "push" ] && [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Extract version from tag (e.g., v1.2.3 -> 1.2.3)
            VERSION=${GITHUB_REF#refs/tags/v}
          elif [ "${{ github.event_name }}" == "release" ]; then
            # Use release tag name (remove 'v' prefix if present)
            VERSION="${{ github.event.release.tag_name }}"
            VERSION=${VERSION#v}
          else
            # Use manual input version
            VERSION="${{ github.event.inputs.version }}"
          fi
          
          # If no version extracted, use chart version from Chart.yaml
          if [ -z "$VERSION" ] || [ "$VERSION" == "null" ]; then
            VERSION=$(grep '^version:' ${{ env.HELM_CHART_DIR }}/Chart.yaml | cut -d' ' -f2 | tr -d '"')
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Chart version: $VERSION"

      - name: Update Chart.yaml version
        run: |
          sed -i "s/^version:.*/version: ${{ steps.chart_version.outputs.version }}/" ${{ env.HELM_CHART_DIR }}/Chart.yaml
          cat ${{ env.HELM_CHART_DIR }}/Chart.yaml

      - name: Package Helm chart
        run: |
          mkdir -p ./dist
          helm package ${{ env.HELM_CHART_DIR }} --destination ./dist
          ls -lah ./dist/

      - name: Set repository URL
        id: repo_url
        env:
          SPACES_ENDPOINT: ${{ secrets.DO_SPACES_ENDPOINT }}
          SPACES_BUCKET: ${{ secrets.DO_SPACES_BUCKET }}
        run: |
          REPO_URL="${SPACES_ENDPOINT}/${SPACES_BUCKET}/"
          echo "url=${REPO_URL}" >> $GITHUB_OUTPUT
          echo "Repository URL: ${REPO_URL}"

      - name: Download existing index.yaml from Spaces
        continue-on-error: true
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.DO_SPACES_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.DO_SPACES_SECRET }}
          AWS_DEFAULT_REGION: ${{ secrets.DO_SPACES_REGION }}
          SPACES_ENDPOINT: ${{ secrets.DO_SPACES_ENDPOINT }}
          SPACES_BUCKET: ${{ secrets.DO_SPACES_BUCKET }}
        run: |
          aws s3 cp s3://${SPACES_BUCKET}/index.yaml ./dist/index.yaml --endpoint-url=${SPACES_ENDPOINT} || echo "No existing index.yaml found"

      - name: Update Helm repository index
        run: |
          REPO_URL="${{ steps.repo_url.outputs.url }}"
          
          # Verify chart files exist
          CHART_COUNT=$(ls -1 ./dist/*.tgz 2>/dev/null | wc -l)
          if [ "$CHART_COUNT" -eq 0 ]; then
            echo "Error: No chart files found in ./dist/"
            exit 1
          fi
          echo "Found $CHART_COUNT chart file(s)"
          
          # Create or update index.yaml
          # Note: helm repo index creates index.yaml inside the specified directory
          if [ -f ./dist/index.yaml ]; then
            echo "Merging with existing index.yaml"
            # Move existing index.yaml to current directory for merge
            cp ./dist/index.yaml ./index.yaml
            helm repo index ./dist --url "${REPO_URL}" --merge ./index.yaml
            rm -f ./index.yaml
          else
            echo "Creating new index.yaml"
            helm repo index ./dist --url "${REPO_URL}"
          fi
          
          # Verify index.yaml was created (it should be in ./dist/)
          if [ -f ./dist/index.yaml ]; then
            echo "index.yaml created successfully in ./dist/"
            cat ./dist/index.yaml
          else
            echo "Error: index.yaml was not created in ./dist/"
            exit 1
          fi

      - name: Upload chart and index to DigitalOcean Spaces
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.DO_SPACES_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.DO_SPACES_SECRET }}
          AWS_DEFAULT_REGION: ${{ secrets.DO_SPACES_REGION }}
          SPACES_ENDPOINT: ${{ secrets.DO_SPACES_ENDPOINT }}
          SPACES_BUCKET: ${{ secrets.DO_SPACES_BUCKET }}
        run: |
          # Upload chart package
          aws s3 cp ./dist/*.tgz s3://${SPACES_BUCKET}/ --acl public-read --endpoint-url=${SPACES_ENDPOINT}
          
          # Upload index.yaml
          aws s3 cp ./dist/index.yaml s3://${SPACES_BUCKET}/index.yaml --acl public-read --content-type "text/yaml" --endpoint-url=${SPACES_ENDPOINT}
          
          echo "âœ… Chart uploaded successfully!"

      - name: Generate artifact summary
        run: |
          REPO_URL="${{ steps.repo_url.outputs.url }}"
          echo "## Helm Chart Published ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Chart:** \`${{ env.CHART_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.chart_version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** \`${REPO_URL}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Add the Helm repository:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "helm repo add netmaker-k8s-ops ${REPO_URL}" >> $GITHUB_STEP_SUMMARY
          echo "helm repo update" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Install the chart:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "helm install netmaker-k8s-ops netmaker-k8s-ops/netmaker-k8s-ops \\" >> $GITHUB_STEP_SUMMARY
          echo "  --version ${{ steps.chart_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
