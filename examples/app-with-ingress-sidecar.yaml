# Example: Application with Ingress Sidecar
# This deployment exposes your application directly to the Netmaker network
# using netclient + proxy sidecars in the same pod

apiVersion: v1
kind: Secret
metadata:
  name: netclient-token
  namespace: default
type: Opaque
stringData:
  token: "your-netclient-token-here"  # Replace with your actual token
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app-ingress-sidecar
  namespace: default
spec:
  replicas: 2
  selector:
    matchLabels:
      app: my-app
  template:
    metadata:
      labels:
        app: my-app
    spec:
      containers:
      # Your application container
      - name: app
        image: nginx:alpine
        ports:
        - containerPort: 80
          name: http
        # Application should listen on 0.0.0.0 to accept connections from sidecar
        # Nginx by default listens on all interfaces, so no config needed
        resources:
          requests:
            memory: "64Mi"
            cpu: "100m"
          limits:
            memory: "128Mi"
            cpu: "200m"
      
      # Netclient sidecar - provides WireGuard connectivity to Netmaker network
      - name: netclient
        image: gravitl/netclient:v1.2.0
        env:
        - name: TOKEN
          valueFrom:
            secretKeyRef:
              name: netclient-token
              key: token
        - name: DAEMON
          value: "on"
        - name: LOG_LEVEL
          value: "info"
        volumeMounts:
        - name: netclient-config
          mountPath: /etc/netclient
        - name: netclient-logs
          mountPath: /var/log
        securityContext:
          privileged: true
          capabilities:
            add:
            - NET_ADMIN
            - SYS_MODULE
        readinessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - "ip link show netmaker && ip addr show netmaker | grep inet"
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 12
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 128Mi
      
      # Ingress proxy sidecar - listens on Netmaker IP, forwards to app
      - name: ingress-proxy
        image: alpine/socat:latest
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Starting ingress proxy sidecar..."
          
          # Wait for netclient to establish WireGuard interface
          echo "Waiting for WireGuard interface..."
          WIREGUARD_IP=""
          for i in $(seq 1 60); do
            if ip addr show netmaker 2>/dev/null | grep -q 'inet '; then
              WIREGUARD_IP=$(ip addr show netmaker | grep 'inet ' | awk '{print $2}' | cut -d/ -f1)
              echo "Detected WireGuard IP: $WIREGUARD_IP"
              break
            fi
            sleep 1
          done
          
          # Fallback: try other common interface names
          if [ -z "$WIREGUARD_IP" ]; then
            for iface in wg0 wg1; do
              if ip addr show $iface 2>/dev/null | grep -q 'inet '; then
                WIREGUARD_IP=$(ip addr show $iface | grep 'inet ' | awk '{print $2}' | cut -d/ -f1)
                echo "Detected WireGuard IP on $iface: $WIREGUARD_IP"
                break
              fi
            done
          fi
          
          # Last resort: bind to all interfaces
          if [ -z "$WIREGUARD_IP" ]; then
            echo "Warning: Could not detect WireGuard IP, binding to 0.0.0.0"
            WIREGUARD_IP="0.0.0.0"
          fi
          
          # Start socat to forward from WireGuard IP to app container
          APP_PORT="${APP_PORT:-80}"
          echo "Starting ingress proxy: $WIREGUARD_IP:$APP_PORT -> localhost:$APP_PORT"
          exec socat TCP-LISTEN:$APP_PORT,bind=$WIREGUARD_IP,reuseaddr,fork TCP:localhost:$APP_PORT
        env:
        - name: APP_PORT
          value: "80"  # Port your app listens on
        securityContext:
          capabilities:
            add:
            - NET_BIND_SERVICE
        resources:
          requests:
            cpu: 50m
            memory: 32Mi
          limits:
            cpu: 100m
            memory: 64Mi
        # Health check
        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - "netstat -tuln | grep -q ':80 ' || exit 1"
          initialDelaySeconds: 10
          periodSeconds: 30
      
      volumes:
      - name: netclient-config
        emptyDir: {}
      - name: netclient-logs
        emptyDir: {}
---
# Optional: Service for internal cluster access (not required for Netmaker access)
apiVersion: v1
kind: Service
metadata:
  name: my-app-ingress-sidecar
  namespace: default
spec:
  ports:
  - port: 80
    targetPort: 80
    protocol: TCP
  selector:
    app: my-app
  type: ClusterIP

